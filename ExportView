function removeVietnameseTones(str) {
  var accentsMap = {
    '√†': 'a', '√°': 'a', '·∫°': 'a', '·∫£': 'a', '√£': 'a',
    '√¢': 'a', '·∫ß': 'a', '·∫•': 'a', '·∫≠': 'a', '·∫©': 'a', '·∫´': 'a',
    'ƒÉ': 'a', '·∫±': 'a', '·∫Ø': 'a', '·∫∑': 'a', '·∫≥': 'a', '·∫µ': 'a',
    '√®': 'e', '√©': 'e', '·∫π': 'e', '·∫ª': 'e', '·∫Ω': 'e',
    '√™': 'e', '·ªÅ': 'e', '·∫ø': 'e', '·ªá': 'e', '·ªÉ': 'e', '·ªÖ': 'e',
    '√¨': 'i', '√≠': 'i', '·ªã': 'i', '·ªâ': 'i', 'ƒ©': 'i',
    '√≤': 'o', '√≥': 'o', '·ªç': 'o', '·ªè': 'o', '√µ': 'o',
    '√¥': 'o', '·ªì': 'o', '·ªë': 'o', '·ªô': 'o', '·ªï': 'o', '·ªó': 'o',
    '∆°': 'o', '·ªù': 'o', '·ªõ': 'o', '·ª£': 'o', '·ªü': 'o', '·ª°': 'o',
    '√π': 'u', '√∫': 'u', '·ª•': 'u', '·ªß': 'u', '≈©': 'u',
    '∆∞': 'u', '·ª´': 'u', '·ª©': 'u', '·ª±': 'u', '·ª≠': 'u', '·ªØ': 'u',
    '·ª≥': 'y', '√Ω': 'y', '·ªµ': 'y', '·ª∑': 'y', '·ªπ': 'y',
    'ƒë': 'd',
    '√Ä': 'A', '√Å': 'A', '·∫†': 'A', '·∫¢': 'A', '√É': 'A',
    '√Ç': 'A', '·∫¶': 'A', '·∫§': 'A', '·∫¨': 'A', '·∫®': 'A', '·∫™': 'A',
    'ƒÇ': 'A', '·∫∞': 'A', '·∫Æ': 'A', '·∫∂': 'A', '·∫≤': 'A', '·∫¥': 'A',
    '√à': 'E', '√â': 'E', '·∫∏': 'E', '·∫∫': 'E', '·∫º': 'E',
    '√ä': 'E', '·ªÄ': 'E', '·∫æ': 'E', '·ªÜ': 'E', '·ªÇ': 'E', '·ªÑ': 'E',
    '√å': 'I', '√ç': 'I', '·ªä': 'I', '·ªà': 'I', 'ƒ®': 'I',
    '√í': 'O', '√ì': 'O', '·ªå': 'O', '·ªé': 'O', '√ï': 'O',
    '√î': 'O', '·ªí': 'O', '·ªê': 'O', '·ªò': 'O', '·ªî': 'O', '·ªñ': 'O',
    '∆†': 'O', '·ªú': 'O', '·ªö': 'O', '·ª¢': 'O', '·ªû': 'O', '·ª†': 'O',
    '√ô': 'U', '√ö': 'U', '·ª§': 'U', '·ª¶': 'U', '≈®': 'U',
    '∆Ø': 'U', '·ª™': 'U', '·ª®': 'U', '·ª∞': 'U', '·ª¨': 'U', '·ªÆ': 'U',
    '·ª≤': 'Y', '√ù': 'Y', '·ª¥': 'Y', '·ª∂': 'Y', '·ª∏': 'Y',
    'ƒê': 'D'
  };
  return str.split('').map(function (char) {
    return accentsMap[char] || char;
  }).join('');
}

exports.exportMetadata = function (app) {
  var year = app.yearDropdown.getValue();
  var source = app.imageSourceDropdown.getValue();
  var wardName = app.selectedWardName;

  if (!year || !wardName || source !== "Sentinel-2") {
    print("Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß: Ph∆∞·ªùng, NƒÉm v√† ch·ªçn ngu·ªìn ·∫£nh l√† Sentinel-2");
    return;
  }

  var wardNameNoAccent = removeVietnameseTones(wardName).replace(/\s+/g, '');
  var wardFeature = app.Thu_Duc.filter(ee.Filter.eq("Ten1", wardName));
  var geometry = wardFeature.geometry();

  var s2 = ee.ImageCollection("COPERNICUS/S2_HARMONIZED")
    .filterBounds(geometry)
    .filterDate(year + '-01-01', year + '-12-31')
    .filter(ee.Filter.lt("CLOUDY_PIXEL_PERCENTAGE", 20));

  var median = s2.median().clip(geometry);
  var bands = median.select(['B4', 'B3', 'B2']);

  var stats = bands.reduceRegion({
    reducer: ee.Reducer.minMax().combine(ee.Reducer.mean(), '', true),
    geometry: geometry,
    scale: 30,
    bestEffort: true,
    maxPixels: 1e9
  });

  var metadata = s2.map(function (img) {
    return ee.Feature(null, {
      'WARD': wardNameNoAccent,
      'YEAR': year,
      'ID': img.id(),
      'DATE': ee.Date(img.get('system:time_start')).format('yyyy-MM-dd'),
      'CLOUDY_PIXEL_PERCENTAGE': img.get('CLOUDY_PIXEL_PERCENTAGE'),
      'B4_min': stats.get('B4_min'), 'B4_max': stats.get('B4_max'), 'B4_mean': stats.get('B4_mean'),
      'B3_min': stats.get('B3_min'), 'B3_max': stats.get('B3_max'), 'B3_mean': stats.get('B3_mean'),
      'B2_min': stats.get('B2_min'), 'B2_max': stats.get('B2_max'), 'B2_mean': stats.get('B2_mean')
    });
  });

  var metaList = metadata.toList(50);

  metaList.evaluate(function (features) {
    var panel = ui.Panel({
      style: {
        width: '400px',
        height: '300px',
        backgroundColor: '#f0f0f0',
        padding: '10px'
      }
    });

    // Ti√™u ƒë·ªÅ
    panel.add(ui.Label('üìã D·ªØ li·ªáu Metadata cho: ' + wardName + ' - ' + year, {
      fontWeight: 'bold',
      fontSize: '16px',
      margin: '0 0 10px 0'
    }));

    // Duy·ªát v√† th√™m t·ª´ng d√≤ng metadata
    features.forEach(function (f, index) {
      var props = f.properties;
      var line = (index + 1) + '. ID: ' + props.ID +
        ', Ng√†y: ' + props.DATE +
        ', Cloud: ' + props.CLOUDY_PIXEL_PERCENTAGE + '%' +
        ', B4_mean: ' + props.B4_mean;
      panel.add(ui.Label(line, { fontSize: '12px', margin: '2px 0' }));
    });

    // G·∫Øn panel v√†o v√πng hi·ªÉn th·ªã
    app.metadataPanel.clear();
    app.metadataPanel.add(panel);
  });
};
